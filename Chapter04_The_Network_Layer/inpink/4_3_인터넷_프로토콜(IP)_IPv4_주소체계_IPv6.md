> 목차

👉[4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등](#43-인터넷-프로토콜ip-ipv4-주소체계-ipv6-등)　   
　   [4.3.1 IPv4 데이터그램 포맷](#431-ipv4-데이터그램-포맷)　   　   
　   [4.3.2 IPv4 주소체계](#432-ipv4-주소체계)　   　       
　   [4.3.3 IPv6](#433-ipv6)　   　       
　   [4.3.4 네트워크 주소 변환(NAT)](#434-네트워크-주소-변환nat)　   　       

　   
　   
　   
## 4.3 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

오늘날의 네트워크에서는 인터넷 프로토콜(IP, Internet Protocol)을 많이 사용한다.　   
IP 버전에는 IPv4와 IPv6가 대표적인데, 그 중에서도 IPv4를 대부분 사용하고 있다.　   
이번 장에서는 IP의 주소체계, IPv4, IPv6, Nat에 대해 배워보겠다. 　   

　   
### 4.3.1 IPv4 데이터그램 포맷

인터넷 네트워크 계층(3)의 패킷을 우리는 **데이터그램**이라고 부른다고 했다.　   
IPv4 데이터그램의 "포맷(형식)"에 대해 알아보자.　   
　   
　   
ⓐ 버전 번호　   
 : 4비트로 되어있다. IP 프로토콜의 version을 뜻한다.　   
 : 라우터는 버전 번호를 통해 데이터그램의 나머지 부분이 IPv4형식이구나 라는 것을 확인하고 해석한다. IP 버전마다 데이터그램의 포맷이 다르기 때문이다. 　   
 : IPv4의 데이터그램의 포맷은, 300p 그림 4.17를 참고하자. 　   
 : 참고로 IPv6의 데이터그램의 포맷은, 315p 그림 4.26을 참고하자.　   
　   
ⓑ 헤더 길이　   
 : 4비트로 되어있다. 아래에서 배우겠지만, IPv4 데이터그램은 헤더에 "가변 길이 옵션 헤더"를 포함한다.　    따라서, 결정된 헤더의 총 크기를 알려줌으로써 "실제 페이로드(실제 Data)가 시작되는 위치"를 알 수 있다. 　   
 : 총 헤더 길이는, 위 사진에서 보듯 대체로 20바이트이다. Data부분이 Payload가 된다. Option까지는 다 헤더이다.　   
　   
 ⓒ 서비스 타입　   
 : 각기 다른 유형의 IP 데이터그램을 구별한다.　   
 : 이는 네트워크 관리자가 결정하고 관리하는 정책에 따라 달라질 수 있다. 　   
　   
 ⓓ 데이터그램 길이　   
 : 바이트로 계산한 IP 데이터그램(헤더+데이터)의 총 길이이다. 　   
　   
 ⓔ 식별자, 플래그, 단편화 오프셋　   
 : 이 3개의 field는 "IP 단편화"와 관련있다. 이는, 큰 크기의 IP 데이터그램이 여러 개의 작은 IP 데이터그램으로 분할되고, 각자 독립적으로 목적지로 전달되어 모이기 때문에 필요하다. 　   
 : 참고로, IPv6는 단편화를 허용하지 않는다. 그래서 315p를 보면 IPv6의 구조에는 이 3개의 field가 없는 것을 확인할 수 있다.　   　   
　   
ⓕ TTL(time-tolive)　   
 : 이 필드는 네트워크에서 데이터그램이 무한히 순환하지 않도록 한다. 라우팅 루프를 막는다는 것이다. 이 필드값은, 라우터가 데이터그램을 한 번 다룰 때마다 감소한다. TTL 필드값이 0이 되면, 라우터에서 이 데이터그램을 폐기한다.　   
　   
ⓖ 프로토콜　   
 : 전달될 목적지의 전송계층(4)의 프로토콜을 명시한다. 　   
 : 예) UDP, TCP　   
　   
ⓗ 헤더 체크섬　   
 : 앞서 배운 것처럼, IP 데이터그램의 "비트 오류"를 탐지할 때 사용한다.　   
 : 3.3절에서 배운 것처럼, 1의 보수를 이용한다. 　   
　   
ⓘ 옵션　   
 : 이 필드를 통해 IP 헤더를 확장할 수 있다. 보통은 이 옵션 필드는 사용되지 않는다.　   
 : 앞서 우리는 헤더 길이를 통해 페이로드 시작점을 확인할 수 있다고 했다. 하지만 이 옵션 필드가 존재함으로, 옵션에 값이 있을 수도 있기 때문에 초기에 "데이터 필드 시작점"을 지정해주기 어렵다.　    
 : IPv6에서는 아예 옵션필드를 허용하지 않는다. 같은 원리로, IPv6에서는 헤더 길이도 40바이트로 고정해주기 때문에 "헤더 길이(ⓑ)"가 필요가 없다.　   
　   
ⓙ 데이터(페이로드)　   
 : 전송 계층(4)의 세그먼트(TCP나 UDP)를 담거나, 　   
 : 네트워크 계층(3)의 인터넷 제어 메시지 프로토콜(ICMP)을 담기도 한다. 　   
 : 참고로, ICMP에 대한 내용은 5단원에서 자세히 배운다.　   
　   
 　   
### 4.3.2 IPv4 주소체계

인터넷 네트워크 계층(3)에서 가장 중요한 프로토콜인 IPv4이다.　   
　   
IPv4 주소체계를 살펴보기 전에, "호스트와 라우터"가 인터넷에 연결되는 방식을 알아볼 필요가 있다.　   
호스트와 라우터는 "링크"에 연결되기 전, 이들의 "경계"로 데이터를 내보내고 받는다.　   
이 경계를 "인터페이스"라고 부른다.　   
　   
　   
1. IP 주소는 32비트(4바이트)이다.　   
   : 2^32개 (약 40억 개)의 주소를 사용할 수 있다.　   
　   
2. 주로 "십진 표기법(dotted-decimal notation)"을 사용한다.　   
   : 주소의 각 바이트를 10진수로 표현하고, 점(.)으로 구분한다.　   
   : 예) 193.32.216.9 = 11000001 00100000 11011000 00001001　   
　   
3. 전 세계 인터넷의 모든 호스트와 라우터들은 **고유한 IP 주소를 갖는다**　   
   : 단, 4.3.4절에서 배울 **NAT 뒤의 인터페이스들은 제외한다.** 위에서 본 것처럼 IP 주소는 개수의 한계가 있기 때문에, 모든 호스트들과 라우터를 다 담기엔 역부족이다. 그래서 NAT처럼 특정 구역(홈, 회사 등)의 네트워크를 1개의 IP주소를 사용하고, 내부 구역에서는 사설 주소를 사용하는 것이다. 따라서, 이 때는 내부 호스트들과 라우터들은 이 세상 어떤 IP와 겹치지 않는 고유한 IP 주소가 아니다. 그 구역 내부에서만 의미있고, 외부에서는 효력을 가지지 않으며, 다른 IP 주소와도 겹칠 수 있다. 　   
   : IP주소는 마음대로 선택할 수 없다. IP주소의 "일부"는 연결된 "서브넷"이 결정한다.　   
   　   
4. 303p 그림 4.18　   
   : 이 그림은, **3개의 인터페이스를 갖는 1개의 라우터가 7개의 호스트와 연결된** 장면이다.　   
   : **라우터는 3개의 인터페이스가 있기에, 3개의 IP주소를 가지고 있다**　   
   : 라우터와, 호스트에 할당된 IP주소를 잘 보도록 하자.　   
   : 왼쪽 3개 호스트는 모두 223.1.1.xxx 형식의 IP주소를 갖는다.  아래 2개는 223.1.3.XX이다.　   
　   
　   
5. 서브넷　   
   : 서브넷은  IP 네트워크, 네트워크라고도 불린다.　   
   : 말 그대로, 네트워크의 일부 조각이다.　   
   : 왼쪽 3개 호스트의 "인터페이스" + 라우터의 "인터페이스" = 1개의 서브넷(subnet)　   
   : 이 1개의 서브넷은 서로 이더넷 LAN으로 연결되어있다.  **하나의 네트워크로, 각각을 중계하는 라우터 없이 4개의 "인터페이스들이" 상호연결되어 있다**.　   
   : 참고로 이더넷인 이유는 유선 연결이기 때문이다. 만약 무선이라면 WiFi로 연결되어 있을 것이다.　   
　   
　   
6. 서브넷 마스크　   
   : 서브넷 주소 표기를 보면 223.1.1.0/24 이런식으로 되어있는데,　   
   : 여기서 /24에서 24는 **서브넷 마스크 또는 프리픽스(prefix)**라고 한다. **32비트 주소의 왼쪽 24비트가 서브넷 주소**라는 뜻이다! 　   
   : 즉, 서브넷 223.1.1.0/24은 **223.1.1.1, 223.1.1.2, 223.1.1.3, 223.1.1.4** ..이런 식으로 구성된다.　   
   : **서브넷 마스크 x가 24일 때, 32-24=8, 그 서브넷은 2^8-2=254개의 내부 IP 주소를 가진다. 　   223.1.1.a에서 a가 1부터 254까지 나올 수 있어서 254개가 있다는 의미이다. **　   
   : **이 때, -2를 해주는 이유는, 223.1.1.0과 223.1.1.255처럼 맨 앞과 맨 뒤는, 특별한 사용을 위해 예약해두고 내부 호스트/라우터들이 주로 사용하지 않는다.**　   
   　   
   : 또, 223.1.1.0/24, 223.1.2.0/24, 223.1.3.0/24 이런 식으로, 하나의 라우터에서 사용하는 인터페이스 IP 주소들에 규칙성을 주면 용이하다.　   
　   
　   
7. CIDR(Classless InterDomain Routing)　   
   : 32비트 IPv4주소를 두 부분으로 나눈다. a.b.c.d/x 형식으로 나타낸다.　   
   : 형식을 보면, 바로 위에서 배운 "서브넷 마스크"와 매우 유사하다.　   
   : CIDR 방식을 사용하기 전, **하나의 서브넷에서 사용하는 네트워크 개수(서브넷 마스크 수에 따라 달라짐)는 2^8개, 2^16개, 2^24개 이렇게 3가지로 고정되어 있었다.**　   
   : 즉, 서브넷 마스크를 8,16,24비트로 제한한 것이다.　   
   : 이 방식은 다양한 문제가 있었다. /24 서브넷은 256개로 너무 적었다. 반면 /16 서브넷은 65634개로 너무 많았다. 2000개 정도만 필요한데도, 최소한  /16 서브넷을 할당해주고 약 63000개의 할당 가능한 너무 많은 IP 자원을 고갈시켰다. 　   
   : 따라서, CIDR은 서브넷 마스크를 직접 정의할 수 있게 해준다. 8,16,24외로도 20, 21같은 크기를 지정해줄 수 있다.　   
　   
8. 주소 집약(address aggregation)　   
   : 위에서 계속 본 것처럼, 보통 한 기관은 연속되는 주소 블록을 할당받는다.　   
   : 이 때, **공통 주소**를 두고, 이 기관 서브넷 내에 들어오는 모든 데이터를 이 주소로 받는다.　   
   : 예를 들어, 200.23.16.0/20, 200.23.18.0/20, 200.23.20.0/20... 등 8개의 주소를 가지는 기관이 있다고 해보자. 대표 공통 주소로 200.23.16.0/20를 두자. 외부에서는 200.23.16.0/20로 모든 데이터를 보내게 된다. 　   
   : **주소 블록 200.23.16.0/20에 자체 서브넷을 갖는 8개의 조직이 있다는 것을 외부에서 알 필요가 없다**　   
　 　     
　   　   
### 4.3.3 IPv6

32비트 IPv4의 주소 부족 문제로 개발되었다. 　   
서브넷, NAT 등을 이용하여 아직 IPv4의 주소 공간이 고갈되지 않았다. 　   
현재에도 대부분 IPv4를 사용하고 있다. 추후 IPv6이 사용될 수 있다.　   
　   
> IPv6의 데이터그램 포맷　   

ⓐ 확장된 주소 기능 : 기존 32비트-> 128비트를 사용하기 때문에 IP주소가 고갈될 일이 없다.　   
ⓑ 애니캐스트 주소 도입 : 기존 유니캐스트, 멀티캐스트 -> 애니캐스트 추가. 애니캐스트는 동일한 IP 주소를 가진 여러 대의 서버 또는 장치 중에서 가장 가까운(또는 최적의) 노드에 요청을 전달하는 통신 방식　   
ⓒ 간소화된 40바이트 헤더 : IPv4의 많은 필드가 빠졌다. 필요없는 헤더를 제거하여 라우터가 IP 데이터그램을 더 빠르게 처리할 수 있게 해준다. 　   
ⓓ 흐름 레이블링 : 데이터그램의 흐름을 파악하는데 쓰인다. 흐름에 따라 우선순위를 두고, 데이터그램 프로토콜 종류를 구분하는 등 사용될 수 있다.　   
　   
　   
　   
### 4.3.4 네트워크 주소 변환(NAT)

 위에서 본 것처럼 IP 주소는 개수의 한계가 있기 때문에, 모든 호스트들과 라우터를 다 담기엔 역부족이다. 그래서 NAT처럼 특정 구역(홈, 회사 등)의 네트워크가 1개의 공인 IP주소를 사용하고, 내부 구역에서는 사설 주소들을 사용한다.　   
 공인 IP와, 사설 IP를 따로 두는 것이다. 사설 IP는 그 기관/홈 내부에서만 쓸 수 있다. 　   
 　   
 따라서, 이 때는 내부 호스트들과 라우터들은 이 세상 어떤 IP와 겹치지 않는 고유한 IP 주소가 아니다. 그 구역 내부에서만 의미있고, 외부에서는 효력을 가지지 않으며, 다른 IP 주소와도 겹칠 수 있다. 　   

　   
> NAT 가능 라우터

311p의 그림 4.25를 보자. 홈 네트워크의 호스트 3개는, 모두 이 "NAT 가능 라우터"로 연결된다. 　   
이 라우터의 공인 IP인 138.76.29.7이 대표적으로 사용된다. 　   
　   
NAT 가능 라우터에는 **NAT 변환테이블**이 있다.　   
WAN에서 같은 목적지 IP인 138.76.29.7로 데이터그램을 보낸다. 라우터는 NAT 변환 테이블을 이용해서 **내부 호스트를 구분**해서 전달해준다. 　   
NAT 변환 테이블에는 **WAN의 공인 IP주소, 포트번호 <=> LAN의 내부 IP주소, 포트번호**가 담겨있다! 　   
