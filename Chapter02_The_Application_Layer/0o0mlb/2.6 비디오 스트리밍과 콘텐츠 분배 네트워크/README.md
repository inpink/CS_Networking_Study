# 2.6 비디오 스트리밍과 콘텐츠 분배 네트워크
## 2.6.1 인터넷 비디오
녹화된 비디오는 서버에 저장되어 사용자가 비디오 시청을 서버에게 `온디맨드`로 요청한다

비디오는 이미지의 연속으로서 일반적으로 초당 24개 또는 30개의 이미지로 일정한 속도로 표시된다

압축되지 않은 디지털 인코딩된 이미지는 픽셀 단위로 구성되며, 각 픽셀은 휘도와 색상을 나타내는 여러 비트들로 인코딩된다

비디오의 중요한 특징은 `압축`될 수 있다는 것인데, 비디오 품질과 비트 전송률은 서로 `반비례`한다(trading off)

오늘날의 상용 압축 알고리즘은 근본적으로 원하는 모든 비트 전송률로 비디오를 압축할 수 있다.
비트 전송률이 높을수록 이미지 품질이 좋아지고, 전반적인 사용자 시청 환경이 향상된다

네트워크 측면에서 비디오의 가장 두드러진 특성은 `높은 비트 전송률`이다.

압축된 인터넷 비디오는 일반적으로 고화질 동영상을 스트리밍하기 위해 100 kbps에서 4 Mbps 이상으로 구성된다
4 K 스트리밍은 10 Mbps 이상의 비트 전송률로 예상된다.
이는 하이엔드(high-end) 동영상의 경우 트래픽과 스토리지 용량이 엄청나게 필요함을 의미한다

스트리밍 비디오에서 가장 중요한 성능 척도는 `평균 종단 간 처리량`이다.
연속재생을 제공하기 위해, 네트워크는 압축된 비디오의 전송률 이상의 스트리밍 애플리케이션에 대한 평균 처리량을 제공해야 한다

또한, 압축을 사용하여 동일한 비디오를 여러 버전의 품질로 만들 수 있다

---
## 2.6.2 HTTP 스트리밍 및 DASH
HTTP 스트리밍에서 비디오는 HTTP 서버 내의 특정 URL을 갖는 일반적인 파일로 저장된다
1. 클라이언트는 서버에게 TCP 연결을 설립하고, 해당 URL에 대한 `HTTP GET 요청`을 발생시킨다
2. 서버가 기본 네트워크 프로토콜 및 트래픽 조건이 허용되는 대로 HTTP 응답 메시지 내에서 비디오 파일을 전송한다
3. 클라이언트 쪽에서 애플리케이션 버퍼에 전송된 바이트가 저장된다
4. 버퍼의 바이트 수가 미리 정해진 임곗값(threshold)을 초과하면 클라이언트 애플리케이션이 재생을 시작한다

스트리밍 비디오 애플리케이션은 클라이언트 애플리케이션 버퍼에서 주기적으로 비디오 프레임을 가져와서 프레임을 압축해제한 다음
사용자의 화면에 표시한다. 즉, 비디오의 후반 부분에 해당하는 프레임을 수신하고 버퍼링할 때 비디오를 표시한다

### HTTP 스트리밍의 문제점
모든 클라이언트가 그들 사이의 `가용 대역폭의 차이`에도 불구하고 똑같이 인코딩된 비디오를 전송받는다

가용 대역폭 차이는 각기 다른 클라이언트들 간에 존재할 뿐만 아니라 동일한 클라이언트에서도 시간에 따른 차이가 발생한다

이로 인해 새로운 형태의 HTTP 기반 스트리밍인 `DASH(Dynamic Adaptive Streaming over HTTP)`가 개발되었다.

### DASH
비디오는 여러 가지 버전으로 인코딩되며, 각 버전은 비트율과 품질 수준이 서로 다르다
- 클라이언트는 동적으로 서로 다른 버전의 비디오를 몇 초 분량의 길이를 갖는 비디오 조각(chunk) 단위로 요청한다
- 가용 대역폭이 충분할 때는 높은 비트율의 비디오 버전을 요청하며, 적을 때는 낮은 비트율의 비디오 버전을 요청한다
- 클라이언트는 HTTP GET 요청을 이용해 다른 버전의 비디오 조각을 매번 선택한다

서로 다른 인터넷 접속 회선을 가진 클라이언트들에게 서로 다른 인코딩률을 갖는 비디오를 선택할 수 있도록 허용한다

클라이언트에게 세션 유지 중에 시간에 따라 변환하는 종단 간 가용 대역폭에 적응할 수 있도록 허용한다

각 비디오 버전은 HTTP 서버에 서로 다른 URL을 가지고 저장된다
- HTTP 서버는 비트율에 따른 각 버전의 URL을 제공하는 `매니페스트 파일(manifest file)`을 갖고 있다
- 클라이언트는 매니페스트 파일을 요청하여 매번 원하는 버전의 비디오 조각 단위 데이터를 선택하여 HTTP GET 요청 메시지에 URL과 byte-range를 지정하여 요청한다
- DASH는 클라이언트가 서로 다른 품질 수준을 자유롭게 변화시킬 수 있도록 허용한다.

---
## 2.6.3 콘텐츠 분배 네트워크(CDN)
인터넷 비디오 회사에서 스트리밍 서비스를 제공하는 가장 단순한 방법은
단일한 거대 데이터 센터를 구축하고 모든 비디오 자료를 데이터 센터에 저장한 뒤 전 세계의 사용자에게 비디오 스트림을 데이터 센터로부터 직접 전송하는 것이다

이 방법에는 문제점이 존재한다
1. 클라이언트가 데이터 센터로부터 지역적으로 먼 지점에 있는 경우, 서버로부터 클라이언트로의 패킷 경로가 거치는 ISP는 각기 다른 대륙에 위치할 수도 있따
2. 인기 있는 비디오는 같은 통신 링크를 통해 여러 번 반복적으로 전송될 것이다
3. 단일한 데이터 센터를 구축하면 한 번의 장애로 인해 전체 서비스가 중단될 수 있는 위험이 있다

이를 해결하기 위해 거의 대부분의 비디오 스트리밍 회사들은 `콘텐츠 분배 네트워크(Content Distribution Network, CDN)`을 이용한다

### CDN
> CDN은 다수의 지점에 분산된 서버들을 운영하며, 비디오 및 다른 형태의 웹 콘텐츠 데이터의 복사본을 이러한 분산 서버에 저장한다

사용자는 최선의 서비스와 사용자 경험을 제공할 수 있는 지점의 CDN 서버로 연결된다

CDN은 콘텐츠 제공자가 소유한 `사설 CDN`이거나 제3자가 운영하는 CDN 일 수 있다

CDN 서버 위치에 대한 두 가지 철학
1. **Enter Deep**: 서버 클러스터를 세계 곳곳의 접속 네트워크에 구축함으로써 ISP의 접속 네트워크로 `깊숙이 들어가는 것`이다.
목적은 서버를 최대한 사용자 가까이에 위치시켜 사용자와 CDN 서버 사이의 링크 및 라우터 수를 줄이고,
지연 시간 및 처리율을 개선하지만, 서버 클러스터를 유지 관리하는 비용이 커진다.

2. **Bring Home**: 좀 더 적은 수의 핵심 지점에 큰 규모의 서버 클러스터를 구축하여 `ISP를 Home으로 가져오는` 개념이다.
접속 ISP에 연결하는 대신, CDN들은 일반적으로 그들의 클러스터를 인터넷 교환 지점(IXP)에 배치된다.
클러스터 유지 및 관리 비용이 줄어드는 대신에 사용자가 느끼는 지연 시간과 처리율은 상대적으로 나빠진다

서버 클러스터의 위치가 정해지면 CDN은 콘텐츠의 복사본을 이들 클러스터에 저장한다

실제로 CDN은 클러스터에 대해 push 방식이 아닌 `pull` 방식을 사용한다

어떤 사용자가 지역 클러스터에 없는 비디오를 요청하면,
해당 비디오를 중앙 서버나 다른 클러스터로부터 전송받아 사용자에게 서비스하는 동시에 복사본을 만들어 저장한다

### CDN 동작
1. 사용자 호스트의 웹 브라우저가 URL을 지정하여 비디오를 요청한다
2. CDN은 그 요청을 가로채 클라이언트에게 가장 적당한 CDN 클러스터를 선택한다
3. 클라이언트의 요청을 해당 클러스터의 서버로 연결한다

### CDN이 사용자의 요청을 가로채고 다른 곳으로 연결하는데 DNS 활용하는 절차
1. 사용자가 URL을 입력한다
2. 사용자의 호스트는 URL의 host name에 대한 질의를 로컬 DNS로 보낸다
3. 로컬 DNS는 호스트 이름의 책임 DNS 서버로 질의를 전달한다
4. 로컬 DNS는 CDN 서버의 책임 DNS 서버로 질의를 전달한다
5. 로컬 DNS는 사용자 호스트에게 CDN 서버의 IP주소를 알려준다
6. 클라이언트는 알게된 IP 주소로 HTTP GET 요청 혹은 DASH를 통해 비디오를 받아온다

### 클러스터 선택 정책
> 클러스터 선택 정책은 클라이언트를 동적으로 어떤 서버 클러스터 또는 CDN 데이터 센터로 연결하는 방식이다

CDN이 DNS를 통해 사용자의 요청을 가로채는 과정에서 클라이언트의 로컬 DNS 서버의 IP 주소를 알게된다.

이 IP 주소에 기초해 `최선의 클러스터`를 선택할 필요가 있다.

일반적인 클러스터 선택 기법이 있다.
1. `지리적으로 가장 가까운` 클러스터 할당하는 기법: 상용 지리정보 데이터베이스를 이용하면 로컬 DNS 서버의 IP 주소는 지리적으로 매핑될 수 있다. 일부 클라이언트에서는 잘 동작하지 않을 수 있다.
2. `실시간 측정`: 클러스터와 클라이언트 간의 지연 및 손실 선응에 대한 현재의 네트워크 트래픽 상황을 반영한 최선의 클러스터를 선택한다. 문제가 많은 로컬 DNS 서버는 응답하지 않도록 설정되어 있다.

---
## 2.6.4 사례연구: 넷플릭스, 유튜브
### 넷플릭스
넷플릭스 비디오 배포에는 두가지 주요 구성요소인 아마존 클라우드와 자체 CDN 인프라가 있다

넷플릭스 **아마존 클라우드**의 기능
- 콘텐츠 수집(content ingestion): 영화의 스튜디오 마스터 버전을 받아서 아마존 클라우드 시스템의 호스트에 업로드한다
- 콘텐츠 처리(content processing): 고객들의 다양한 플레이어 기기 사양에 적합하도록 각 영화의 여러 가지 형식의 비디오를 생성한다. DASH를 이용하여 HTTP 적응적 스트리밍 서비스를 위해 각 형식별로 다양한 비트율의 여러 가지 버전을 생성한다
- CDN으로의 버전 업로드: 다양한 버전이 생성되면 아마존 클라우드 시스템의 호스트는 이러한 버전을 CDN으로 업로드할 수 있다

자체 CDN을 구축하기 위해 넷플릭스는 IXP 및 거주용 ISP 자체에서 서버 랙을 설치했다.
각각의 랙 서버에는 10 Gbps 이더넷 포트와 100 테라바이트 이상의 스토리지가 있다

넷플릭스는 풀 캐싱(pull-caching)을 사용하여 IXP 및 ISP의 CDN 서버를 채운다

1. 사용자가 재생할 영화를 선택한다
2. 아마존 클라우드에서 실행 중인 넷플릭스 소프트웨어가 먼저 해당 영화 사본을 갖고 있는 CDN 서버를 결정한다
3. 영화가 있는 서버 중에서 소프트웨어는 클라이언트 요청에 `최적의` 서버를 결정한다
4. 로컬 ISP가 CDN 서버 랙에 있다면, 해당 CDN 서버 랙이 선택되고, 아니면, 근처에 있는 IXP 서버가 선택된다
5. 클라이언트는 요청된 영화의 다른 버전에 대한 URL을 가진 매니페스트 파일과 특정 서버의 IP 주소를 보낸다
6. 클라이언트와 해당 CDN 서버는 독점 버전의 DASH를 이용하여 직접 상호작용한다

넷플릭스는 특정 클라이언트를 CDN 서버에 연결하지 위해 `DNS 리다이렉션`을 사용할 필요가 없다.
대신, 아마존 클라우드에서 실행되는 것처럼 넷플릭스 소프트웨어는 클라이언트에게 특정 CDN 서버를 사용하도록 알려준다

넷플릭스 CDN은 `푸시 캐싱(push-caching)`을 사용하고, 콘텐츠 캐시 미스(cache miss) 중에 사용량이 적은 시간 중 `예약된 시간`에 서버에 푸시한다

### 유튜브
넷플릭스와 유사하게 유튜브는 자체 비공개 CDN을 사용하여 동영상을 배포하고 수백 가지 IXP 및 ISP 위치에 서버 클러스터를 설치했다.
거대한 데이터 센터에서 직접 동영상을 배포한다

구글 역시 사용자를 특정 서버 클러스터와 연결하는 `DNS`을 사용한다.
대부분의 경우 구글의 클러스터 선택 정책은 클라이언트와 클러스터 간의 `RTT가 가장 적은 곳`을 연결하는 것이다

유튜브는 `HTTP 스트리밍`을 채용하여 각기 다른 비트율과 품질을 갖는 여러 단계의 버전을 생성하여 제공한다.
DASH와 같은 적응적 스트리밍 대신에 사용자가 스스로 버전을 선택하게 했다

유튜브는 HTTP byte-range 헤더를 이용해 목표한 분량의 선인출 데이터 이후에 추가로 전송되는 데이터 흐름을 제한한다

유튜브는 사용자로부터 서버로의 비디오 업로드에도 HTTP 스트리밍을 사용한다


