# 2.4 DNS: 인터넷의 디렉터리 서비스
### 호스트 이름
호스트의 식별자 중 하나는 `호스트 이름(hostname)`이다.

하지만, 호스트 이름은 인터넷에서의 그 호스트 위치에 대한 정보를 거의 제공하지 않고,
가변 길이의 알파뉴메릭 문자로 구성되므로 라우터가 처리하는 데 어려움이 있다.

### IP 주소
호스트는 `IP 주소(IP address)`로도 식별된다

IP 주소는 4바이트로 구성되고 계층 구조를 갖는다.
- `127.7.106.83`과 같은 형태로 0 ~ 255의 십진수로 표현하는 각 바이트는 점으로 구분한다.
- 계층구조여서 주소를 왼쪽에서 오른쪽으로 조사함으로써, 그 호스트가 인터넷의 어디에 위치하는지에 대한 자세한 정보를 얻을 수 있다

## 2.4.1 DNS가 제공하는 서비스
> 인터넷 DNS(domain name system)는 호스트 이름을 IP 주소로 변환해 주는 디렉터리 서비스이다.

DNS란
1. DNS의 서버들의 계층구조로 구현된 `분산 데이터베이스`
2. 호스트가 분산 데이터베이스로 질의하도록 허락하는 애플리케이션 계층 프로토콜
3. DNS 서버는 주로 BIND 소프트웨어를 수행하는 유닉스 컴퓨터이다
4. DNS 프로토콜은 `UDP`상에서 수행되고 `포트 번호 53`을 이용한다

## 사용자의 호스트에서 수행되는 브라우저가 URL을 요청할 때 발생하는 일
1. 같은 사용자 컴퓨터는 DNS 애플리케이션의 클라이언트 측을 수행한다
2. 브라우저는 URL로부터 호스트 이름을 추출하고 그 호스트 이름을 DNS 애플리케이션의 클라이언트 측에 넘긴다
3. DNS 클라이언트는 DNS 서버로 호스트 이름을 포함하는 질의를 보낸다
4. DNS 클라이언트는 호스트 이름에 대한 IP 주소를 가진 응답을 받게 된다
5. 브라우저가 DNS로부터 IP 주소를 받으면 해당 IP 주소와 그 주소의 80번 포트에 위치하는 HTTP 서버 프로세스로 TCP 연결을 초기화한다

## DNS의 추가 서비스
- **호스트 에일리어싱(host aliasing)**: 복잡한 호스트 이름을 가진 호스트는 하나 이상의 별명을 가질 수 있다. DNS는 별칭 호스트 이름에 대한 정식 호스트 이름을 얻기 위해 이용될 수 있다.
- **메일 서버 에일리어싱(mail server aliasing)**: 전자 메일 주소는 간단하지만 그 서버의 호스트 이름은 일반적으로 더 복잡하다. DNS는 제공된 별칭 호스트 이름에 대한 정식 호스트 이름을 얻기 위해 매일 애플리케이션에 의해 수행된다.
- **부하 분산(load distribution)**: DNS는 중복 웹 서버 같은 여러 중복 서버 사이에 부하를 분산하기 위해서도 사용된다. DNS의 순환 방식은 여러 중복 서버들 사이에서 트래픽을 분산하는 효과를 낸다.

---
## 2.4.2 DNS 동작 원리 개요
1. 애플리케이션은 변환될 호스트 이름을 명시하여 DNS 측의 클라이언트를 호출한다
2. 사용자 호스트의 DNS는 네트워크에 질의 메시지를 보낸다. 모든 DNS 질의와 응답 메시지는 `포트 53의 UDP 데이터그램`으로 보내진다.
3. 지연 후, 사용자 호스트의 DNS는 요청한 매핑에 해당하는 DNS 응답 메시지를 받는다
4. 이 매핑은 호출한 애플리케이션으로 전달된다

### DNS가 중앙 집중 데이터베이스일 때 생길 문제점
- 서버의 고장: 만약 이 네임 서버가 고장 나면, 전체 인터넷이 작동하지 않는다
- 트래픽 양: 단일 DNS 서버가 모든 DNS 질의를 처리해야 한다
- 먼 거리의 중앙 집중 데이터베이스: 단일 DNS 서버가 모든 질의 클라이언트로부터 가까울 수만은 없다. 이는 매우 심각한 지연을 일으킬 수 있다
- 유지관리: 단일 네임 서버는 모든 인터넷 호스트에 대한 레코드를 유지해야 한다. 자주 갱신 해야 하고, 인증 문제가 존재한다.

즉, 단일 DNS 서버에 있는 중앙 집중 데이터베이스는 `확장성이 전혀 없다`

### 분산 계층 데이터베이스
세 유형의 DNS 서버가 있다. `루트(root) DNS 서버`, `최상위 레벨 도메인 네임(top-level domain, TLD) DNS 서버`, `책임(authoritative) DNS 서버`

**루트 DNS 서버**
- 1000개 이상의 루트 서버 인스턴스가 전 세계에 흩어져 있다
- 루트 네임 서버는 TLD 서버의 IP 주소들을 제공한다

**최상위 레벨 도메인(TLD) DNS 서버**
- com, org, net, edu, gov 같은 `상위 레벨 도메인`과 kr, uk, fr, ca, jp 같은 `모든 국가의 상위 레벨 도메인`에 대한 TLD 서버가 있다
- TLD 서버는 책임 DNS 서버에 대한 IP 주소를 제공한다

**책임 DNS 서버**
- 기관의 책임 DNS 서버는 이 `DNS 레코드`를 갖고 있다
- 기관은 DNS 레코드를 갖도록 자신의 책임 DNS 서버의 구현을 선택할 수 있고, 일부 서비스 제공자의 책임 DNS 서버에 이 레코드를 저장하도록 비용을 지불한다

**로컬 DNS 서버**
- 서버들의 계층 구조에 엄격하게 속하지는 않지만, DNS 구조의 중심에 있다
- ISP들은 로컬 DNS 서버를 갖고, 호스트가 ISP에 연결될 때, 그 ISP는 로컬 DNS 서버로부터 IP 주소를 호스트에게 제공한다
- 호스트의 로컬 DNS 서버는 대체로 호스트에 가까이 있다

`cse.nyu.edu`가 `gaia.cs.umass.edu`의 IP 주소를 원한다면?
1. 자신의 로컬 DNS 서버에 질의를 보낸다. 질의에는 변환되어야 하는 호스트 이름 `gaia.cs.umass.edu`가 포함된다
2. 로컬 DNS 서버는 그 질의 메시지를 루트 DNS 서버에게 전달한다
3. 루트 DNS 서버는 `edu`를 인식하고, `edu`에 대한 책임을 가진 TLD 서버의 IP 주소 목록을 로컬 DNS 서버에 보낸다
4. 로컬 DNS 서버는 TLD 서버에 질의를 보낸다
5. TLD 서버는 `umass.edu`를 인식하고, `dns.umass.edu`로 이름 지어진 책임 DNS 서버의 IP 주소로 응답한다
6. 로컬 DNS 서버는 책임 DNS 서버로 질의 메시지를 다시 보낸다
7. 최종 `gaia.cs.umass.edu`의 IP 주소를 응답한다
8. 호스트에 최종 IP 주소를 응답한다

여기서 총 `8번`의 DNS 메시지가 보내졌다. `재귀적 질의(recursive query)`와 `반복적 질의(iterative query)`를 사용한다

일반적으로 TLD 서버가 책임 DNS 서버를 알지 않고 책임 DNS 서버를 아는 중간 DNS 서버를 알고 있다면, 총 10번의 메시지를 보내게 된다

### DNS 캐싱
> DNS는 지연 성능 향상과 네트워크의 DNS 메시지 수를 줄이기 위해 캐싱을 사용한다

질의 사슬에서 DNS 서버가 DNS 응답을 받았을 때 로컬 메모리에 응답에 대한 정보를 저장할 수 있다.

DNS 서버는 호스트 이름에 대한 책임이 t없을 때조차 원하는 주소를 제공할 수 있다. 

로컬 DNS 서버는 구체적인 IP 주소 이외에도 TLD 서버의 IP를 저장하여 루트 DNS 서버를 우회할 수 있게 한다

---
## 2.4.3 DNS 레코드와 메시지
DNS 분산 데이터베이스를 구현한 DNS 서버들은 호스트 이름을 IP 주소로 매핑하기 위해 `자원 레코드(resource record, RR)`를 저장한다

자원 레코드는 다음과 같은 필드를 포함하는 4개의 튜플(tuple)로 되어 있다
``` (Name, Value, Type, TTL) ```

`TTL(time to live)`은 자원 레코드의 생존 기간이다

`Name`과 `Value`의 의미는 Type에 따른다
- **Type = A** 이면, Name은 호스트 이름이고 Value는 호스트 이름에 대한 IP 주소다. ex. `(relay1.bar.foo.com, 145.37.93.126, A)`
- **Type = NS** 이면, Name은 도메인이고 Value는 도메인 내부의 호스트에 대한 IP 주소를 얻을 수 있는 방법을 아는 책임 DNS 서버의 호스트 이름이다. ex. `(foo.com, dns.foo.com, NS)`
- **Type = CNAME** 이면, Name은 별칭 호스트 이름이고 Value는 별칭 호스트 이름에 대한 정식 호스트 이름이다. ex. `(foo.com, relay1.bar.foo.com, CNAME)`
- **Type = MX** 이면, Name은 별칭 호스트 이름이고 Value는 별칭 호스트 이름을 갖는 메일 서버의 정식 이름이다. ex. `(foo.com, mail.bar.foo.com, MX)`

DNS 서버가 특별한 호스트 이름에 대한 책임 서버이면, 그 DNS 서버는 그 호스트 이름에 대한 Type A 레코드를 포함한다

서버가 호스트 이름에 대한 책임 서버가 아니라면, 그 서버는 호스트 이름을 포함하는 도메인에 대한 Type NS 레코드를 포함할 것 이고,
NS 레코드의 Value 필드에 DNS 서버의 IP 주소를 제공하는 Type A 레코드도 포함할 것이다

### DNS 메시지

**헤더 영역(header section)**
처음 12바이트로 여러 필드를 갖고 있다
- 첫 필드는 질의를 식별하는 16비트 숫자로 질의에 대한 응답 메시지에 복사되어, 클라이언트가 보낸 질의와 수신된 응답 간의 일치를 식별한다
- 플래그 필드에는 여러 개의 필드가 있다
  - 1비트의 `질의/응답 플래그`: 메시지가 질의(0)인지 응답(1)인지 구별한다
  - 1비트의 `책임 플래그`: DNS 서버가 질의 이름에 대해 책임 서버일 때 응답 메시지에 설정된다
  - 1비트의 `재귀 요구 플래그`: DNS 서버가 레코드를 갖지 않을 때 재귀적 질의를 수행하기를 클라이언트가 원할 때 설정된다
  - 1비트의 `재귀 가능 필드`: DNS 서버가 재귀 질의를 지원하면 응답에 설정된다
- 4개의 `개수`필드: 데이터 영역의 네 가지 타입의 발생 횟수를 나타낸다

**payload**
- `질문 영역(question section)`: 현재 질의에 대한 정보를 포함한다. 질의 되는 이름을 포함하는 이름 필드와 이름에 대해 문의되는 질문 타입을 나타내는 타입 필드를 포함한다
- `답변 영역(answer section)`: DNS 서버로부터의 응답에서 원래 질의된 이름에 대한 자원 레코드를 포함한다. 호스트 이름은 여러 개의 IP 주소를 가질 수 있기 때문에 응답으로 여러 개의 RR을 보낼 수 있다
- `책임 영역(authority section)`: 다른 책임 서버의 레코드를 포함한다
- `추가 영역(additional section)`: 다른 도움이 되는 레코드를 포함한다

### DNS 데이터베이스에 레코드 삽입
도메인 네임을 등록기관에 등록한다
> 등록기관(registrar)은 도메인 네임의 유일성을 확인하고, 그 도메인 이름을 DNS 데이터베이스에 넣고, 그 서비스에 대한 약간의 요금을 받는 상업 기관이다

도메인 네임을 어떤 등록기관에 등록할 때 등록기관에 `주책임 서버`와 `부책임 서버`의 이름과 IP 주소를 등록기관에 제공한다.
- 책임 DNS 서버 각각에 대해 등록기관은 `Type NS`와 `Type A`레코드가 **TLD 서버**에 등록되도록 확인한다
- `Type A`레코드와 메일 서버에 대한 `Type MX`자원 레코드가 **책임 DNS 서버**에 등록되는 것을 확인한다

모든 단계가 끝나면 사람들이 웹사이트를 방문할 수 있고 전자메일을 보낼 수 있다
