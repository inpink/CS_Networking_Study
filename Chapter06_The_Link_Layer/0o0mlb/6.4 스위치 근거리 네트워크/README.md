# 6.4 스위치 근거리 네트워크
스위치 네트워크에서는 링크 계층 프레임을 전달하기 위해 IP 주소가 아닌 `링크 계층 주소`를 사용한다

## 6.4.1 링크 계층 주소체계와 ARP
호스트와 라우터는 링크 계층 주소와 네트워크 계층 주소를 갖는다

### MAC 주소
**링크 계층 주소**를 가진 것은 호스트나 라우터의 어댑터 (네트워크 인터페이스)이다

다수의 네트워크 인터페이스를 갖고 있는 호스트나 라우터는 여러 개의 링크 계층 주소를 갖게 된다

링크 계층 주소는 `랜 주소`, `물리 주소`, `MAC 주소` 라고도 알려져 있다

`MAC 주소`
- 길이가 6바이트이며, 주로 16진수 표기법으로 주소가 표시된다
- 평면 구조를 가지며 어댑터의 위치에 따라 변경되지 않는다

어댑터가 프레임을 목적지 어댑터로 전송할 때, 송신 어댑터는 프레임에 **목적지 어댑터의 MAC 주소**를 넣고 그 프레임을 랜상으로 전송한다

프레임을 수신한 어댑터는 프레임 안의 목적지 MAC 주소가 어댑터 자신의 MAC 주소와 일치하는지를 검사한다
- 일치하면, 어댑터는 프레임에 포함된 데이터그램을 추출하여 프로토콜 스택의 위쪽으로 전달한다
- 일치하지 않으면, 어댑터는 그 프레임을 폐기한다

송신 어댑터는 프레임의 **목적지 주소 필드**에 특수한 `MAC 브로드캐스트 주소`를 넣는다. 6바이트 주소를 사용하는 랜에서 브로드캐스트 주소는 `48개의 1로 된 비트열`이다

### ARP
`ARP`는 네트워크 계층 주소 (ex. 인터넷 IP 주소)와 링크 계층 주소 (ex. MAC 주소)의 주소 사이의 **변환**을 해준다

DNS vs ARP
- DNS: 인터넷의 임의의 장소에 있는 호스트의 호스트 네임을 해결
- ARP: 동일한 서브넷상에 있는 호스트나 라우터 인터페이스의 IP 주소만 해결

ARP의 동작은 다음과 같다

1. 각 호스트와 라우터는 자신의 메모리에 `ARP 테이블`을 갖고 있다. ARP 테이블은 IP 주소, MAC 주소, TTL 값을 포함한다
2. 송신 호스트는 주어진 IP 주소로부터 목적지 MAC 주소를 획득해야만 한다
3. 송신 노드는 `ARP 패킷`이라는 특수 패킷을 구성하고, ARP 질의 패킷을 어댑터에게 전달하여 **MAC 브로드캐스트 주소로 패킷을 전송**하도록 지시한다
4. 어댑터는 ARP 패킷을 링크 계층 프레임에 캡슐화하고, 이 프레임의 목적지 주소를 브로드캐스트 주소로 해서 **서브넷으로 전송**한다
5. ARP 질의를 포함하는 프레임은 서브넷 상의 다른 모든 어댑터에 의해 수신되며, 브로드캐스트 주소 때문에 각 어댑터는 프레임에 들어 있는 ARP 패킷을 자신의 ARP 모듈로 전달한다
6. ARP 모듈은 자신의 IP 주소가 ARP 패킷에 들어 있는 목적지 IP 주소와 일치하는지 검사한다
7. 일치하는 노드는 요구된 매핑 정보가 포함된 **응답 ARP 패킷**을 질의한 노드로 돌려보낸다
8. 질의 호스트는 **자신의 ARP 테이블을 갱신**하고, 자신의 IP 데이터그램을 링크 계층 프레임으로 캡슐화해서 전송한다. 이때 프레임의 목적지 MAC 주소는 **ARP 질의에 대한 응답을 보낸 호스트나 라우터의 MAC 주소**가 된다

ARP 프로토콜의 특징은 다음과 같다
1. 질의 ARP 메시지는 `브로드캐스트 프레임`으로 전송되는 반면, 응답 ARP 메시지는 `표준 프레임`으로 전송된다
2. ARP는 플러그 앤 플레이(plag-and-play)로, 노드의 ARP 테이블이 자동으로 구축된다
3. ARP는 링크 계층과 네트워크 계층의 경계에 있는 프로토콜이다

### 서브넷이 없는 노드로의 데이터그램 전송
1. 데이터그램을 라우터 인터페이스인 `첫 홉 라우터`로 전달한다. ARP을 사용하여 MAC 주소를 통해 호스트에서 라우터까지 전달한다
2. 라우터는 데이터그램이 전달될 정확한 인터페이스를 결정하기 위해 **포워딩 테이블**을 참조하여 자신의 어댑터로 전달한다
3. 어댑터는 데이터그램을 새 프레임에 캡슐화하여 전송한다. 이 프레임의 목적지 MAC 주소는 최종 목적지의 MAC 주소가 되고 이는 ARP를 통해 얻는다

---
## 6.4.2 이더넷
이더넷은 처음으로 널리 사용된 고속랜, 토큰링보다 저렴, 같거나 그 이상의 데이터율로 동작하는 장점으로 오늘날 자주 사용한다.

1990년대 후반에는 랜을 허브 기반의 스타 토폴로지를 사용하는 이더넷으로 대체했지만, 2000년대 스타 토폴로지의 중앙의 허브가 **스위치**로 대체 되었따

### 이더넷 프레임 구조
- 데이터 필드 (46~1500 바이트): IP 데이터그램을 운반한다
- 목적지 주소 (6바이트): 목적지 어댑터의 MAC 주소를 포함한다
- 출발지 주소 (6바이트): 프레임을 랜으로 전송하는 어댑터의 MAC 주소를 포함한다
- 타입 필드 (2바이트): 네트워크 계층 프로토콜을 다중화하도록 허용한다
- 순환 중복 검사 (4바이트): 수신 어댑터가 프레임에 오류가 생겼는지 검출한다
- 프리앰블 (8바이트): 첫 7바이트는 수신 어댑터를 깨우고 수신자의 클록을 송신자의 클록과 동기화하는 역할이고, 8번째 바이트의 마지막 두 비트는 수신 어댑터에게 '중요한 것'이 오고 있음을 알린다

이더넷 기술은 네트워크 계층에게 `비연결형`, `비신뢰적` 서비스를 제공한다

### 이더넷 기술
이더넷은 링크 계층과 물리 계층 모두에 대한 명세이며, 동축케이블, 동선, 광섬유와 같은 다양한 물리 매체상으로 전달한다

---
## 6.4.3 링크 계층 스위치
스위치의 역할은 들어오는 링크 계층 프레임을 수신해서 **출력 링크로 전달**하는 것이다.

### 포워딩과 필터링
`필터링`은 프레임을 **인터페이스로 전달할지, 폐기할지** 결정하는 스위치의 기능이다

`포워딩`은 프레임이 전송될 인터페이스를 결정하고, 프레임을 해당 인터페이스로 내보내는 기능이다

스위치의 필터링과 포워딩은 `스위치 테이블`을 이용한다. 스위치 테이블에는 MAC 주소, MAC 주소로 가게 하는 스위치 인터페이스, 해당 엔트리가 테이블에 만들어진 시점에 대한 정보가 들어있다

스위치의 인덱싱에는 다음 세 가지 경우가 가능하다
1. 목적지 주소에 대한 엔트리가 없다면 스위치는 프레임을 브로드캐스트한다
2. 엔트리가 있다면 프레임을 제거함으로써 필터링 기능을 수행한다
3. 연관된 엔트리가 있다면 출력 버퍼에 프레임을 넣음으로써 포워딩 기능을 수행한다

### 자가학습
스위치는 자신의 테이블을 자동으로, 동적으로, 자치적으로 구축하는 `자가학습` 특징이 있다

1. 스위치 테이블은 초기에 비어 있다
2. 스위치는 테이블에 송신 노드가 상주하는 랜 세그먼트를 기록한다
3. 일정시간 후에도 스위치가 해당 주소를 출발지 주소로 하는 프레임을 수신하지 못하면 테이블에서 이 주소를 삭제한다

스위치는 네트워크 관리자나 사용자의 개입을 요구하지 않으므로 **플러그 앤 플레이 장치** 이고, 전이중으로써 충돌 없이 동시에 전송할 수 있다

### 링크 계층 스위치의 특성
스위치의 장점은 다음과 같다

1. 충돌 제거: 충돌로 인해 낭비되는 대역폭이 없다
2. 이질적인 링크들: 스위치는 링크들을 별개로 분리하기 때문에 랜의 각 링크는 상이한 속도로 동작할 수 있으며 상이한 매체를 사용할 수 있다
3. 관리: 네트워크 관리를 쉽게 할 수 있게 해준다

### 스위치 대 라우터
`스위치`
- 저장-후-전달 패킷 스위치이지만 MAC 주소를 사용해서 패킷을 전달한다
- 2계층 패킷 스위치
- 플러그 앤 플레이 장치
- 상대적으로 높은 패킷 필터링 및 전달률을 갖는다
- 네트워크의 실제 사용되는 토폴로지는 스패닝 트리로 제한된다
- 대규모 스위치 네트워크에서는 커다란 ARP 테이블과 상당한 양의 ARP 트래픽이 생성되고 처리된다
- 브로드캐스트 트래픽의 폭주에 대비한 방안을 제공하지 않는다
- 소규모 네트워크에 적합하다

`라우터`
- 저장-후-전달 패킷 스위치이지만 IP 주소를 사용한다
- 3계층 패킷 스위치
- 패킷이 스패닝 트리로 제한받지 않고 출발지와 목적지 간의 최상의 경로를 사용할 수 있다
- 브로드캐스트 폭풍에 대비한 방화벽 보호 기능을 가지고 있다
- 플러그 앤 플레이가 아니다
- 스위치보다 패킷당 처리 시간이 더 크다
- 대규모 네트워크에 적합하다

---
## 6.4.4 가상 근거리 네트워크(VLAN)
스위치 랜에 세 가지 단점이 있다
- 트래픽 격리의 부족: 브로드캐스트 트래픽은 여전히 전체 네트워크로 전달되어야만 한다
- 스위치의 비효율적인 사용
- 사용자 관리

위의 단점은 `가상 근거리 네트워크(VLAN)`으로 해결할 수 있다

> VLAN을 지원하는 스위치는 하나의 물리적 근거리 네트워크 인프라스트럭처상에서 여러 개의 가상 근거리 네트워크들을 정의할 수 있다

VLAN에서는 네트워크 관리자가 스위치 포트(인터페이스)를 그룹으로 나눈다.
각 그룹은 하나의 VLAN을 구성하며, 한 VLAN의 포트들은 하나의 브로드캐스트 도메인을 형성한다
